name: Deploy to PM2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 104.248.84.190
          username: www-data
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            export PATH="$HOME/.bun/bin:$HOME/.local/bin:/var/www/.nvm/versions/node/v22.17.0/bin:$PATH"

            # First time setup: clone repo
            if [ ! -d /var/www/log-viewer/.git ]; then
              mkdir -p /var/www/log-viewer
              git clone https://github.com/alex-mextner/log-viewer.git /var/www/log-viewer
            fi

            cd /var/www/log-viewer

            # Pull latest changes
            git fetch origin main
            git reset --hard origin/main

            # Install dependencies
            bun install

            # Create logs dir for PM2
            mkdir -p logs

            # Open firewall port (if ufw is available)
            sudo ufw allow 3001/tcp 2>/dev/null || true

            # Restart PM2 process
            pm2 delete log-viewer 2>/dev/null || true
            pm2 start ecosystem.config.json
            pm2 save

            # Wait and show logs
            sleep 2
            pm2 logs log-viewer --lines 20 --nostream

            # Test API (uses password from .env)
            echo "Testing API..."
            source .env
            curl -s "http://localhost:3001/api/logs?pwd=$LOG_PASSWORD&limit=2" | head -c 500 || true

            # Check if process is running
            pm2 status log-viewer
